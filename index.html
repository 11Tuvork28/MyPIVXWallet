<!DOCTYPE html>
<html lang='en'>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
  <meta content="utf-8" http-equiv="encoding">
  <meta http-equiv="X-UA-Compatible" content="IE=9" />
  <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" type="text/css" href="assets/bootstrap-4.5.0/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="assets/style/style.css">
  <script type="text/javascript" src="assets/bootstrap-4.5.0/js/jquery.js"></script>
  <script type="text/javascript" src="assets/bootstrap-4.5.0/js/bootstrap.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jdenticon@3.1.0/dist/jdenticon.min.js" async
        integrity="sha384-VngWWnG9GS4jDgsGEUNaoRQtfBGiIKZTiXwm9KpgAeaRn6Y/1tAFiyXqSzqC8Ga/" crossorigin="anonymous">
  </script>
</head>

<body>
  <div id="page-container">
    <div id="content-wrap">
      <nav class="navbar navbar-expand-lg sticky-top navbar-light navbarSpecial">
        <img class="navbar-brand" src='assets/logo.png' alt="ZENZO"
          style='vertical-align: middle;width:150px;display:inline'>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
          aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav mr-auto" style="cursor: pointer;">
            <li class="nav-item"><a id='start' class="nav-link tablinks" onclick="openTab(event, 'home')">Intro</a></li>
            <li class="nav-item"><a class="nav-link tablinks"
                onclick="openTab(event, 'keypair')">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link tablinks" onclick="openTab(event, 'Transaction')">Create
                Transaction</a></li>
            <li style="display: none;" class="nav-item"><a class="nav-link tablinks"
                onclick="startNetworkTest();openTab(event, 'WalletData');">Network Data</a></li>
            <li class="nav-item"><a class="nav-link tablinks"
                onclick="openTab(event, 'Settings');">Settings</a></li>
          </ul>
        </div>
      </nav>
      <br>
      <div style='display:none;background-color:red;margin-bottom:15px;' id='outdated'>WARNING: your version is outdated,
        please update to the newest stable version at the <a
          href='https://github.com/ZENZO-Ecosystem/zenzo-web3/releases'>ZENZO Web 3.0 Github</a></div>

      <div class="container-fluid">
        <div class="row no-gutters">
          <div class='col-md-1'>
            <div style='float:center'>
              <div id='Debug' style='color:#00b7ff'></div>
              <div id='Network' style='color:#00b7ff'></div>
            </div>
          </div>
          <div class='col-md-10'>
            <div id="home" class="tabcontent">
              <center>
                <h3> Welcome to the ZENZO Web wallet! </h3>
              </center>
              <h4> A wallet for everyone! </h4>
              <h5 style='text-indent: 30px;'>
                This web wallet is designed to be able to run on any computer with a modern browser, from a Raspberry Pi
                to Gaming Desktop.
                It has also been designed to generate wallets and create transactions without requiring a direct
                network connection.
                Make sure when you run this wallet to run it from a trusted source such as zenzo.io or download it from
                the Github and run it on your computer.
              </h5>
              <h4> Generate Paper wallets </h4>
              <h5 style='text-indent: 30px;'>
                This web wallet functions much like a paper wallet generator, but with features most normal wallets
                have. You can also generate transactions offline!
                Head over to the wallet tab and generate your first wallet. Make sure to keep the key secure! otherwise
                you may lose all your coins.
              </h5>
            </div>
            <div id="keypair" class="tabcontent">
              <h3>Generate ZNZ wallet</h3>
              <div id='importWallet' style='display:none;'>
                <input type="text" id='privateKey' placeholder="Private Key">
                <button onclick="importWallet()">Import wallet</button>
              </div>
              <div id='generateWallet'>
                <button onclick="generateWallet()">Create A New Wallet</button>
              </div>
              <br>
              <div id='generateVanityWallet'>
                <input style="display:none;" type="text" id='prefix' placeholder="Address Prefix">
                <button onclick="generateVanityWallet()">Create A Vanity Wallet</button>
              </div>
              <br>
              <button id='wToggle' onclick='toggleWallet()'>Access My Wallet</button>
              <br>
              <br>
              <h4 id='genKeyWarning' style='display:none;'><b>Warning: if you do not save your generated private key you
                  will not have access to the coins associated with that key</b></h4>
              <br>
              <div id="guiWallet" style="display: none;">
                <div id="banners" style="height: 160px; width: 100%; display: flex; flex-wrap: wrap; color: white; margin-bottom: 250px;">
                  <div class="graybox" style="height: 99%; width: 300px; background-color: #7070e3;">
                    <h3 style="margin: 10px; position: relative; left: 165px;">Address</h3>
                    <br>
                    <div>
                      <canvas id="identicon" class="innerShadow" width="65" height="65" data-jdenticon-value="" style="background-color: white; border-color: white; border-width: 3px; border-style: solid; border-radius: 1000px; position: relative; top: -30px; left: 10px;"></canvas>
                      <b id="guiAddress" style="line-break: anywhere; width: 60%; display: inline-block; right: -30px; position: relative; font-size: smaller; bottom: 50px; word-break: break-all; font-family: monospace; font-weight: 300;">---</b>
                    </div>
                  </div>
                  <div class="graybox" style="height: 99%; width: 300px; background-color: #5a78f0;">
                    <h3 style="margin: 10px; position: relative; left: 135px;">Balance &nbsp;&nbsp;<span id="balanceReload" class=reload onclick="refreshChainData()">&#x21bb;</span></h3>
                    <div>
                      <div style="display: inline-block; position: relative; width: 65px; height: 65px; left: 10px; bottom: -8px; border-style: solid; border-radius: 1000px; border-width: 3px; background-size: cover; background-image: url(assets/logo-circle.png);"></div>
                      <p style="display: inline-block; width: 50%; position: relative; right: -65px; bottom: 19px; font-size: x-large;"><b id="guiBalance">---</b> ZNZ</p>
                    </div>
                  </div>
                </div>
                <div style="display: inline;">
                  <button id="guiViewKey" onclick="toggleKeyView()">View Private Key</button>
                  <div id="PrivateQR"  style="display: none; padding: 10px;"></div>
                  <div id="PublicQR"   style="display: none; padding: 10px;"></div>
                </div>
                <div id='PrivateTxt' style="display: none;"></div>
              </div>
            </div>
            <div id="Transaction" class="tabcontent">
              <div id='errorNotice'></div>
              <div class='pullDown' style='clear:both;'>
                <div onclick='toggleDropDown("loadSimpleTransactions")'>Create Simple Transactions<span
                    style='float:right;'>▼</span></div>
                <div id='loadSimpleTransactions' style='display:none'>
                  In order to use simple transactions you must first load your wallet
                  <br>
                  <button onclick='loadUnspendInputs()'>Load Wallet</button>
                </div>
                <div id='simpleTransactions' style='display:none'>
                  <label>Address</label>
                  <input type="text" id="address1s">
                  <label>Amount</label>
                  <input type="text" id="value1s">
                  <br>
                  <div id='HumanReadable'></div>
                  <br>
                  <button onclick="createSimpleTransation()" id='genIt'>Send Transaction</button>
                </div>
                <div id='transactionFinal'></div>
              </div>
              <br>
              <div class='pullDown' style='clear:both;'>
                <div onclick='toggleDropDown("advTransactions")'>Create Manual Transactions<span
                    style='float:right;'>▼</span></div>
                <div id='advTransactions' style='display:none'>
                  <h2>Inputs</h2>
                  <label>Trx Hash</label>
                  <input type="text" id="prevTrxHash">
                  <label>Index</label>
                  <input type="text" id="index">
                  <label>Script</label>
                  <input type="text" id="script">
                  <h2>Outputs</h2>
                  <label>Output Address 1</label>
                  <input type="text" id="address1">
                  <label>Amount</label>
                  <input type="text" id="value1">
                  <br />
                  <label>Output address 2</label>
                  <input type="text" id="address2">
                  <label>Amount</label>
                  <input type="text" id="value2">
                  <h2>WIF Key</h2>
                  <label>key</label>
                  <input type="text" id="wif">
                  <br /><br />
                  <b>WARNING: ANY FUNDS NOT ALLOCATED WILL BE USED AS FEES</b>
                  <br>
                  <button onclick="createRawTransaction()">Create Raw Signed Transction</button>
                  <br /><br /><br />
                  <h2>Signed Raw Transaction</h2>
                  <textarea rows="15" cols="70" id="rawTrx"></textarea>
                  <h3>Don't understand how this works? <a target='_blank'
                      href='https://github.com/ZENZO-Ecosystem/zenzo-web3#transaction'>Tutorial Here</a>
                    <h4>Advanced Details: <br>locktime is set to 0, sequence is set to max. SIGHASH_ALL option is chosen
                      for signing raw Transaction.</h4>
                </div>
              </div>
            </div>
            <div id="Settings" class="tabcontent">
              <form action="javascript:setExplorer()">
                <label for="explorer">Choose a explorer:</label>
                <select id="explorer" name="explorer">
                  <option value="cryptoid">https://chainz.cryptoid.info/znz</option>
                  <option value="custom">custom (In Development)</option>
                </select>
                <br>
                <input type="submit">
              </form>
              <br>
              <button type="submit" onclick='toggleDebug()'>Toggle Debug mode</button>
              <button type="submit" onclick='toggleNetwork()'>Toggle Networking mode</button>
            </div>
            <div id="WalletData" class="tabcontent">
              <div id='networkingNotices'></div>
              <div id='readout' style='display:none'>
                <div style='float:left;'>
                  Wallet Details
                  <hr>
                  Balance: <span id='balance'></span> | Total Received: <span id='totalReceived'></span> | Total Sent:
                  <span id='totalSent'></span>
                  <br>
                  <div class='pullDown' style='clear:both;'>
                    <div onclick='toggleDropDown("Transactions")'>Transactions:<span
                        id='TransactionNumber'>▼</span><span style='float:right;'>▼</span></div>
                    <div style='background-color:#D0D0D0; width:100%'><span style='display:none;'
                        id='Transactions'></span></div>
                    <br>
                    <br>
                  </div>
                </div>
                <!--Right -->
                <div id='NetworkDataAddrs'>
                  <span style='margin-left:1px;'>Address Response</span>
                  <hr>
                  <span id='addrStr' style='margin-left:1px;'></span><br>
                  <span id='addrStrQR' style='margin-left:1px;'></span>
                </div>
                <div class='pullDown' style='clear:both;'>
                  <div onclick='toggleDropDown("NetworkingJson")'>Pure json:<span style='float:right;'>▼</span></div>
                  <div style='background-color:#D0D0D0; width:100%'>
                    <textarea rows="15" cols="50" id="NetworkingJson"
                      style='display:none;font-size:4vw;width:99%;overflow:hidden;background-color:#D0D0D0;'></textarea>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class='col-md-1'>
          </div>
        </div>
      </div>
    </div>
    <div class="footer">
      <div style='display:inline;' id='dcfooter'></div>
    </div>
  </div>
  <script type="text/javascript" src="scripts/libs/crypto-min.js"></script>
  <script type="text/javascript" src="scripts/libs/crypto-sha256.js"></script>
  <script type="text/javascript" src="scripts/libs/crypto-sha256-hmac.js"></script>
  <script type="text/javascript" src="scripts/libs/ripemd160.js"></script>
  <script type="text/javascript" src="scripts/libs/jsbn.js"></script>
  <script type="text/javascript" src="scripts/libs/ellipticcurve.js"></script>
  <script type="text/javascript" src="scripts/libs/script.js"></script>
  <script type="text/javascript" src="scripts/libs/qrcode.js"></script>
  <script type="text/javascript" src="scripts/libs/sha256.js"></script>

  <script type="text/javascript" src="scripts/settings.js"></script>
  <script type="text/javascript" src="scripts/wallet.js"></script>
  <script type="text/javascript" src="scripts/network.js"></script>
  <script type="text/javascript" src="scripts/bitTrx.js"></script>

  <script>
    // WALLET STATE DATA
    let cachedUTXOs = [];
    let cachedBlockCount = 0;

    function getBalance() {
      let nBalance = 0;
      for (const nUTXO of cachedUTXOs) {
        // Calculate the balance from our UTXO cache
        console.log(nUTXO.value / 100000000);
        nBalance += Number((nUTXO.value / 100000000).toFixed(8));
      }
      return Number(nBalance.toFixed(8));
    }

    let viewPrivKey = false;  
    function toggleKeyView() {
      viewPrivKey = !viewPrivKey;
      document.getElementById('guiViewKey').innerHTML     = viewPrivKey  ? 'View Public Key' : 'View Private Key';
      document.getElementById('PrivateTxt').style.display = viewPrivKey  ? 'block' : 'none';
      document.getElementById('PrivateQR').style.display  = viewPrivKey  ? 'block' : 'none';
      document.getElementById('PublicQR').style.display   = !viewPrivKey ? 'block' : 'none';
    }
    function toggleWallet() {
      var toggle = document.getElementById("wToggle").innerHTML;
      // Hide and Reset the Vanity address input
      document.getElementById('prefix').value = "";
      document.getElementById('prefix').style.display = 'none';
      if (toggle === "Access My Wallet") {
        document.getElementById("generateWallet").style.display = 'none';
        document.getElementById("importWallet").style.display = 'block';
        document.getElementById("wToggle").innerHTML = "Create A New Wallet";
      } else {
        document.getElementById("generateWallet").style.display = 'block';
        document.getElementById("importWallet").style.display = 'none';
        document.getElementById("wToggle").innerHTML = "Access My Wallet";
      }
    }
    async function generateVanityWallet() {
      // Generate a vanity address with the given prefix
      let strPrefix = document.getElementById('prefix');
      if (strPrefix.value.length === 0) {
        // No prefix, display the intro!
        strPrefix.style.display = 'block';
        document.getElementById('genKeyWarning').style.display = 'block';
        document.getElementById('PrivateTxt').innerHTML = "---";
        document.getElementById('guiAddress').innerHTML = "---";
      } else {
        // We also don't want users to be mining addresses for years... so cap the letters to four until the generator is more optimized
        if (strPrefix.value.length > 4) return alert("This is a long name! This would take a LONG time to find, please choose a shorter name!");
        // Cache a lowercase equivilent for lower-entropy comparisons (a case-insensitive search is ALOT faster!) and strip accidental spaces
        const nInsensitivePrefix = strPrefix.value.toLowerCase().replace(/ /g, "");
        let attempts = 0;
        // Begin the search, cap'n!!!
        while (true) {
          let nWallet = await generateWallet(nInsensitivePrefix);
          // Check if the prefix matches the pubkey...
          if (nWallet.vanity_match) return console.log("VANITY: Found an address after " + attempts + " attempts!");
          // No match, bump the attempts
          attempts++;
        }
      }
    }
    function toggleDropDown(id) {
      var openClosed = document.getElementById(id).style.display;
      if (openClosed === 'block') {
        document.getElementById(id).style.display = 'none';
      } else {
        document.getElementById(id).style.display = 'block';
      }
    }
    function startNetworkTest() {
      if (networkEnabled) {
        if (typeof publicKeyForNetwork !== 'undefined') {
          checkPubKey(); //readout
          document.getElementById("readout").style.display = 'block';
          document.getElementById("networkingNotices").innerHTML = '';
        } else {
          document.getElementById("networkingNotices").innerHTML = 'No public key';
        }
      } else {
        document.getElementById("networkingNotices").innerHTML = 'Network disabled';
      }
    }
    function loadUnspendInputs() {
      if (publicKeyForNetwork) {
        getUnspentTransactions();
        document.getElementById("loadSimpleTransactions").style.display = 'none';
        document.getElementById("simpleTransactions").style.display = 'block';
        document.getElementById("genIt").style.display = 'block';
      } else {
        alert("You need a wallet to transact with! Please import a wallet via the 'Dashboard --> Access my wallet' menu");
      }
    }
    function createSimpleTransation() {
      if (!networkEnabled) return alert("Cannot create Simple Transactions in offline mode; this requires an explorer to sync your balance (UTXOs), please enable Networking to use this feature! Otherwise, use 'Advanced Transactions'");
      var address = document.getElementById("address1s").value;
      var value = Number(document.getElementById("value1s").value);
      console.log("Constructing TX of value: " + value + " ZNZ");
      // Loop our cached UTXOs and construct a TX
      trx = bitjs.transaction();
      let txValue = 0;
      for (const UTXO of cachedUTXOs) {
        if (txValue > value) {
          // Required Coin Control value met, yahoo!
          console.log("Coin Control: TX Constructed! Selected " + trx.inputs.length + " input(s) (" + txValue + " ZNZ)");
          break;
        }
        trx.addinput(UTXO.tx_hash, UTXO.tx_ouput_n, UTXO.script);
        txValue += Number((UTXO.value / 100000000).toFixed(8));
        txValue = Number(txValue.toFixed(8));
        console.log("Coin Control: Selected input " + UTXO.tx_hash.substr(0, 6) + "(" + UTXO.tx_ouput_n + ")... (Added " + (UTXO.value / 100000000).toFixed(8) + " ZNZ - Total: " + txValue + ")");
      }

      if (address != '' && value != '') {
        calculatefee(trx.serialize().length);
        trx.addoutput(address, value);//Sending to this address
        addresschange = publicKeyForNetwork;
        totalSent = (parseFloat(fee) + parseFloat(value)).toFixed(8);
        valuechange = (parseFloat(txValue) - parseFloat(totalSent)).toFixed(8);
        if (totalSent <= balance) {
          document.getElementById("HumanReadable").innerHTML = "Balance:" + balance + "<br>Fee:" + fee + "<br>ToAddress:" + address + "<br>HowMuchSend:" + value + "<br>ChangeAddress:" + addresschange + "<br>HowMuchChange:" + valuechange;
          trx.addoutput(addresschange, valuechange);//Change Address
          if (typeof privateKeyForTransactions !== 'undefined') {
            var wif = privateKeyForTransactions;
            sendTransaction(trx.sign(wif, 1));
            document.getElementById("genIt").style.display = 'none';
          } else {
            console.log("No private key");
          }
        } else {
          console.warn("Amount: " + value + "\nFee: " + fee + "\nChange: " + valuechange + "\nTOTAL: " + totalSent);
          document.getElementById("HumanReadable").innerHTML = "You are trying to send more than you have!";
        }
      } else {
        console.log("No address or value");
      }
    }
    function createRawTransaction() {
      //advanced transaction creation and signing
      var trx = bitjs.transaction();
      var txid = document.getElementById("prevTrxHash").value;
      var index = document.getElementById("index").value;
      var script = document.getElementById("script").value;
      trx.addinput(txid, index, script);
      var address = document.getElementById("address1").value;
      var value = document.getElementById("value1").value;
      trx.addoutput(address, value);
      var address = document.getElementById("address2").value;
      var value = document.getElementById("value2").value;
      trx.addoutput(address, value);
      var wif = document.getElementById("wif").value;
      var textArea = document.getElementById("rawTrx");
      textArea.value = trx.sign(wif, 1); //SIGHASH_ALL DEFAULT 1
    }
    function openTab(evt, tabName) {
      var i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("tabcontent");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      tablinks = document.getElementsByClassName("tablinks");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(tabName).style.display = "block";
      if (!evt.currentTarget.className.includes("active"))
        evt.currentTarget.className += " active";
    }
    document.getElementById("start").click();

    function refreshChainData() {
      // If in offline mode: don't sync ANY data or connect to the internet
      if (!networkEnabled) return console.warn("Offline mode: For your security, the wallet will avoid ALL internet requests in offline mode.");

      // Update identicon
      document.getElementById("identicon").dataset.jdenticonValue = publicKeyForNetwork;
      jdenticon();
      // Play reload anim
      document.getElementById("balanceReload").className += " playAnim";
      // Fetch block count + UTXOs
      getBlockCount();
    }

    window.onload = (() => {
      // jdenticon might be missing in offline mode; this is fine
      if (!jdenticon) return;
      // Configure Identicon
      jdenticon.configure({
        saturation: {
          color: 0.8
        }
      });
    })

    setInterval(refreshChainData, 15000);
  </script>
</body>

</html>